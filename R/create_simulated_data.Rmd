---
title: "Chromatin bound protein model simulated data"
author: "Sam Haynes"
date: "2023-03-15"
output: html_document
---

# Overview

The overall picture is that, we have chromatin-enriched samples MS-level protein intensities. But because each sample has been enriched to a different degree, some abundance reflect both the behavior of that protein (more or less abundant in a cell line) but also the technical preparation of that cell line ( more or less  chromatin-enriched).
 
So the whole attempt of the model is to determine how well each sample is prepared (chromatin-enriched) to then figure out if a protein in more abundant in that cell line. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(here)

set.seed(324)

real_protein_dataset <- readRDS(here("data/input/real_data_list.rds"))

```

# Creating simulated data
The simulated dataset will consist of the MS-level protein intensities of 20 proteins taken from a chromatin enriched sample and a cytoplasmic sample for 50 cell lines with two biological replicates.

```{r create-original-simulated-dataset}
n_prot = 50
n_cell_lines = 55
n_reps = 2
n_samples = n_cell_lines * n_reps

perc_chrom = rbeta(n_samples,2.5,2.5) # generates chromatin enrichment of 100 samples (1 = all chromatin, 0 = no chromatin)

cell_types = rep(c(1:n_cell_lines), times = n_reps) #two replicates of each cell line

Total_prot = rnorm(n_prot,20,1) #total abundance of each protein (chrom+non-chrom)

Prot_chrom = runif(n_prot, min = 5, max = 16) # general protein abundance in pure (hypothetical) chromatin samples

final_df = tibble(perc_chrom = perc_chrom) 
#making a chromatin and cytoplasm (non-chrom) matrix 
#col = proteins, row = cell lines, 
#if a protein is more chromatin only in a specific cell line, it will have a positive value in this matrix

chrom_prot_cell_line = matrix(rep(0,n_cell_lines * n_prot), #making a 0 matrix with rows T of tissue and Col P of PRoteins
                           nrow = n_cell_lines, ncol = n_prot)
cyto_prot_cell_line = matrix(rep(0,n_cell_lines * n_prot), #making a 0 matrix with rows T of tissue and Col P of PRoteins
                           nrow = n_cell_lines, ncol = n_prot)

#making some proteins cell line specific
chrom_prot_cell_line[1,1] = 4
cyto_prot_cell_line[1,1] = -3
chrom_prot_cell_line[1,20] = -2
cyto_prot_cell_line[1,20] = 3


#the cytoplasmic/non-chrom fraction of the protein is total-chrom
Prot_cyto = Total_prot - Prot_chrom
for(i in 1:length(Prot_chrom)){
  Prot_id = glue::glue("Prot_{i}")
  Pr_cyto = glue::glue("Pr_cyto_{i}")
  Pr_nucl = glue::glue("Pr_nucl{i}")
  test_dat = tibble(perc_chrom = perc_chrom)
  test_dat_tmp = test_dat|>
    mutate(
      
      !!Pr_nucl  := rnorm( n() , mean= Prot_chrom[i] +chrom_prot_cell_line[cell_types,i]  , sd=0.2 )
      ,
      !!Pr_cyto := rnorm( n(), mean=Prot_cyto[i] +cyto_prot_cell_line[cell_types,i]  , sd=0.2 )
      ,
      #the OBSERVED abundance of the protein in the sample, depends on how much that protein is on pure chromatin and what % of that sample is pure chromatin
      !!Prot_id  := .data[[Pr_cyto]]*(1-perc_chrom)+ .data[[Pr_nucl]]*perc_chrom
    )
  final_df  = cbind(final_df,test_dat_tmp)
}


test_dat = dplyr::select(final_df, matches("Prot")) 
```

```{r sanity_check_simulated_data_savvas}
# Check simulated distribution of enrichment by comparing to shifted observed enrichment
input_enrichment_comparison_savvas <- tibble(simulated = rbeta(115,2.5,2.5),
                                      observed = real_protein_dataset$input_enrichment) |>
  mutate(observed = observed - min(observed),
         observed = observed / max(observed)) |>
  pivot_longer(cols=c("simulated", "observed"), names_to = "source", values_to = "enrichment")

ggplot(input_enrichment_comparison_savvas) +
  geom_histogram(aes(x=enrichment, fill = source),
  position = "identity",
  alpha = 0.8)

# Check simulated protein intensities to real data. Shifted again as I am only interested in the rough shape.
protein_intensities_comparison_savvas <- tibble(simulated = unlist(test_dat),
                                                observed = sample(c(real_protein_dataset$prot_intensity), 50*55*2))  |> 
  mutate(observed = observed - min(observed)) |>
  mutate(simulated = simulated - min(simulated)) |>
  pivot_longer(cols=c("simulated", "observed"), names_to = "source", values_to = "intensity")

ggplot(protein_intensities_comparison_savvas) +
  geom_histogram(aes(x=intensity, fill = source),
  position = "identity",
  alpha = 0.8)

```
I think the current simulated enrichment method is a imperfect Basically you've assumed that actively enriching a sample will have no effect at all on average. I think there should be some bias towards samples being some what efficiently enriched.

I think both simulated intensities need more variance. 

```{r create-sam-simulated-dataset}

protein_abundance <- tibble(protein_id = 1:n_prot,
                               total = rnorm(n_prot,20,1),
                               chromatin = runif(n_prot,
                                                        min = 5,
                                                        max = 16),
                               cyto = total - chromatin)

# Feel free to critique this but instead of hand picking some proteins in some cell lines I've just said all proteins have some sort of bias in every cell line. Most are negligible though! 

protein_cell_line_preference <- tibble(protein_id = rep(1:n_prot,
                                                        each = n_cell_lines),
                                       cell_line = rep(1:n_cell_lines, 
                                                      n_prot),
                                       change_abund = rnorm(n_prot*n_cell_lines, 0, 1))

# I think there should be a slight bias towards efficient enrichment

sample_chromatin_enrichment <- tibble(cell_line = rep(1:n_cell_lines, 
                                                      n_reps),
                                      rep = rep(1:n_reps, 
                                                each = n_cell_lines),
                                      enrichment = rbeta(n_samples,4,2))

sam_test_dataset <- tibble(protein_id = rep(1:n_prot, 
                                            each = n_samples),
       rep = rep(rep(1:n_reps, 
                     each = n_cell_lines), 
                 n_prot),
       cell_line = rep(rep(1:n_cell_lines,
                           n_reps),
                       n_prot)) |>
  inner_join(protein_abundance) |>
  inner_join(sample_chromatin_enrichment) |>
  inner_join(protein_cell_line_preference) |>
  group_by(protein_id, rep, cell_line) |>
  mutate(
    Pr_nucl = rnorm(1,
                     mean = chromatin + change_abund,
                     sd = 1),
    Pr_cyto = rnorm(1,
                    mean= cyto - change_abund,
                    sd = 1),
    prot_int = Pr_cyto * (1-enrichment) + Pr_nucl * enrichment
  )


```

```{r sanity_check_simulated_data_sam}
# Check simulated distribution of enrichment by comparing to shifted observed enrichment
input_enrichment_comparison_sam <- tibble(simulated = sample_chromatin_enrichment$enrichment,
                                      observed = sample(real_protein_dataset$input_enrichment, n_reps*n_cell_lines)) |>
  mutate(observed = observed - min(observed),
         observed = observed / max(observed)) |>
  pivot_longer(cols=c("simulated", "observed"), names_to = "source", values_to = "enrichment")

ggplot(input_enrichment_comparison_sam) +
  geom_histogram(aes(x=enrichment, fill = source),
  position = "identity",
  alpha = 0.8)

# Check simulated protein intensities to real data. Shifted again as I am only interested in the rough shape.
protein_intensities_comparison_sam <- tibble(simulated = sam_test_dataset$prot_int,
                                                observed = sample(c(real_protein_dataset$prot_intensity), 50*55*2))  |> 
  mutate(observed = observed - min(observed)) |>
  mutate(simulated = simulated - min(simulated)) |>
  pivot_longer(cols=c("simulated", "observed"), names_to = "source", values_to = "intensity")

ggplot(protein_intensities_comparison_sam) +
  geom_histogram(aes(x=intensity, fill = source),
  position = "identity",
  alpha = 0.8)

```

```{r create-simple-simulated-dataset}
n_prot = 20 
n_cell_lines = 50
n_reps = 2
n_samples = n_cell_lines * n_reps

protein_abundance_simple <- tibble(protein_id = 1:n_prot,
                               total = rnorm(n_prot,20,1),
                               chromatin = runif(n_prot,
                                                        min = 5,
                                                        max = 16),
                               cyto = total - chromatin)

# Feel free to critique this but instead of hand picking some proteins in some cell lines I've just said all proteins have some sort of bias in every cell line. Most are negligible though! 

protein_cell_line_preference_simple <- tibble(protein_id = rep(1:n_prot,
                                                        each = n_cell_lines),
                                       cell_line = rep(1:n_cell_lines, 
                                                      n_prot),
                                       change_abund = rnorm(n_prot*n_cell_lines, 0, 1))

# I think there should be a slight bias towards efficient enrichment

sample_chromatin_enrichment_simple <- tibble(cell_line = rep(1:n_cell_lines, 
                                                      n_reps),
                                      rep = rep(1:n_reps, 
                                                each = n_cell_lines),
                                      enrichment = rbeta(n_samples,4,2))

sam_test_dataset_simple <- tibble(protein_id = rep(1:n_prot, 
                                            each = n_samples),
       rep = rep(rep(1:n_reps, 
                     each = n_cell_lines), 
                 n_prot),
       cell_line = rep(rep(1:n_cell_lines,
                           n_reps),
                       n_prot)) |>
  inner_join(protein_abundance_simple) |>
  inner_join(sample_chromatin_enrichment_simple) |>
  inner_join(protein_cell_line_preference_simple) |>
  group_by(protein_id, rep, cell_line) |>
  mutate(
    Pr_nucl = rnorm(1,
                     mean = chromatin + change_abund,
                     sd = 1),
    Pr_cyto = rnorm(1,
                    mean= cyto - change_abund,
                    sd = 1),
    prot_int = Pr_cyto * (1-enrichment) + Pr_nucl * enrichment
  )
```

```{r output-simulated-data}
write_csv(sam_test_dataset_simple,
          here("data/output/simulated_dataset.csv"))
```

```{r output-observed-data}
# Real data set is imbalanced. Recommend randomly selecting 2 of the 7 samples for cell line 7. Don't lose too much data and avoids over emphasis on protein behaviour in this cell line. Alternatives require more complex statistics! 

tibble(cell_line = real_protein_dataset$cell_line) |> 
  group_by(cell_line) |> 
  summarise(count = n()) |>
  arrange(desc(count))

resampled_real_dataset <- tibble(sample = rep(1:115, 50),
       cell_line = rep(real_protein_dataset$cell_line, 50),
       input_enrichment = rep(real_protein_dataset$input_enrichment, 50),
       protein = rep(1:50, each = 115),
       prot_intensity = c(real_protein_dataset$prot_intensity)) |>
  group_by(cell_line) |>
  filter(sample %in% sample(unique(sample), 2)) |>
  arrange(protein, cell_line) |>
  ungroup()

real_protein_dataset$N <- 110

real_protein_dataset$prot_intensity <- resampled_real_dataset$prot_intensity |>
  matrix(nrow = 110)

real_protein_dataset$input_enrichment <- resampled_real_dataset$input_enrichment[1:110]

real_protein_dataset$cell_line <- resampled_real_dataset$cell_line[1:110]

saveRDS(real_protein_dataset, here("data/output/subsampled_real_data_list.rds"))
```
