---
title: "Model Execution and Evaluation"
author: "Sam Haynes"
date: "2023-04-03"
output: html_document
---

```{r setup}
library(tidyverse)
library(here)
library(tidybayes)
library(rstan)

perfect_real_data_set <- read_rds(here("data/output/perfect_real_data_set.rds"))

test_enrichment <- read_csv(here("data/input/enrichment_plot_rep_sum_piv.csv")) |>
  arrange(desc(N)) |>
  separate(Sample, sep ="_", into = c("tissue_name", "sample"), extra="merge") |>
  separate(sample, sep ="_(?=[1-9]$)", into = c("cell_line_name", "rep_name")) |>
  mutate(tissue_name = factor(tissue_name),
         cell_line_name = factor(cell_line_name))

#check stan is installed
model_orig <-  stan_model(here('R/hierarchical_model.stan'))

# pass data to stan and run model
options(mc.cores = 4)
```

```{r normalise-raw-intensities-DESeq}
gene_wise_pseudo_ref <- perfect_real_data_set |>
  group_by(ProteinGroup) |>
  summarise(pseudo_ref = exp(sum(log(prot_intensity))/length(prot_intensity)))

sample_wise_scale_factors <- perfect_real_data_set |>
  inner_join(gene_wise_pseudo_ref) |>
  group_by(tissue_name, cell_line_name, rep_name) |>
  summarise(sample_scale_factor = median(prot_intensity / pseudo_ref, na.rm = TRUE)) |>
  ungroup()

perfect_real_data_set_normalised = perfect_real_data_set |>
  inner_join(sample_wise_scale_factors) |>
  mutate(prot_intensity = prot_intensity / sample_scale_factor)
```

```{r run-stan-model-real, eval=FALSE}
n_prot <- 30

n_reps <- 2

subset_perfect_protein_names <- perfect_real_data_set_normalised |> 
  pull(ProteinGroup) |>
  unique() |>
  sample(n_prot)

subset_perfect_data <- perfect_real_data_set_normalised |> 
  filter(ProteinGroup %in% subset_perfect_protein_names)

n_cell_lines <- 11

n_tissues <- 2

protein_intensity_array_real_data <- array(c(subset_perfect_data |>
  filter(tissue_name %in% c("lung", "breast")) |>
  arrange(ProteinGroup,
          tissue, 
          rep,
          cell_line) |>
  pull(prot_intensity)),
  dim = c(n_cell_lines,
          n_reps,
          n_tissues,
          n_prot
          )) |>
  aperm(c(2,3,1,4))

fit_real <- sampling(model_orig,
                     list(cell_lines = n_cell_lines,
                             proteins = n_prot,
                             tissues = n_tissues,
                             prot_intensity = protein_intensity_array_real_data,
                             replicates = n_reps),
                     iter = 1000,
                     chains = 4)


```

```{r explore-posterior}

fit_summary_real <- summary(fit_real)$summary |> 
  as_tibble(rownames = "parameter") |>
  transmute(parameter,
            median = `50%`)

subset_perfect_data_sorted <- subset_perfect_data |>
    filter(tissue_name %in% c("lung", "breast")) |>
    arrange(ProteinGroup,
            tissue, 
            rep,
            cell_line) |> 
  group_by(ProteinGroup,
           tissue, 
           rep) |> 
  mutate(cell_line = 1:11,
         ProteinGroup = factor(ProteinGroup),
         protein_id = unclass(ProteinGroup),
         tissue_name = factor(tissue_name),
         tissue = unclass(tissue_name))

enrichment_comparison <- subset_perfect_data |>
  filter(tissue_name %in% c("lung", "breast")) |>
  arrange(tissue, 
          rep,
          cell_line) |>
          group_by(tissue_name, cell_line_name,
                   rep_name,tissue, cell_line, rep) |> 
          summarise(unique(rep))|>
  inner_join(test_enrichment) |>
  ungroup() |>
  transmute(tissue = rep(1:2, each = 22), rep, N, cell_line = rep(1:11, 4)) |>
  arrange(desc(N)) |>
  mutate(N = 1:44) |>
  inner_join(fit_real |> 
  spread_draws(enrichment[rep,tissue,cell_line]) |>
  summarise_draws())
  

ggplot(enrichment_comparison) +
  geom_point(aes(x= median, y=N)) +
  labs(x="Enrichment")

ggplot( tibble(gen_prot_intensity=c(apply(extract(fit_real,"gen_prot_intensity")$gen_prot_intensity,c(2,3,4,5),median))) |>
         mutate(rep = rep(1:n_reps, n_cell_lines*n_prot*n_tissues),
                tissue = rep(rep(1:n_tissues,each = n_reps), n_prot*n_cell_lines),
                cell_line = rep(rep(1:n_cell_lines, each = n_reps*n_tissues), n_prot),
                protein_id = rep(1:n_prot, each = n_cell_lines*n_reps*n_tissues)) |>
         inner_join(subset_perfect_data_sorted)) +
  geom_point(aes(x = gen_prot_intensity, y = prot_intensity))  +
  labs(x="gen_prot_intensity")

real_post_posterior_check <- fit_summary_real |> 
  filter(str_detect(parameter, "cyto_C")) |>
  transmute(cyto = median) |>
  bind_cols(fit_summary_real |> 
  filter(str_detect(parameter, "m_C")) |>
  transmute(chrom = median)) |>
  mutate(cell_line = rep(rep(1:n_cell_lines, each = n_prot), n_tissues),
         protein = rep(1:n_prot, n_cell_lines * n_tissues))

ggplot(real_post_posterior_check |> filter(cell_line < 21)) +
  geom_point(aes(x=log(cyto), y=log(chrom))) +
  facet_wrap(~cell_line, ncol = 6, scales = "free")
```