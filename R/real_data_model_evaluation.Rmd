---
title: "Model Execution and Evaluation"
author: "Sam Haynes"
date: "2023-04-03"
output: html_document
---

```{r setup}
library(tidyverse)
library(here)
library(tidybayes)
library(rstan)
library(shinystan)

perfect_real_data_set <- read_rds(here("data/output/perfect_real_data_set.rds"))

test_enrichment <- read_csv(here("data/input/enrichment_plot_rep_sum_piv.csv")) |>
  arrange(desc(N)) |>
  separate(Sample, sep ="_", into = c("tissue_name", "sample"), extra="merge") |>
  separate(sample, sep ="_(?=[1-9]$)", into = c("cell_line_name", "rep_name")) |>
  mutate(tissue_name = factor(tissue_name),
         cell_line_name = factor(cell_line_name))

#check stan is installed
model_orig <-  stan_model(here('R/hierarchical_model_lognorm_inc_cyto.stan'))

# pass data to stan and run model
options(mc.cores = 4)
```

```{r normalise-raw-intensities-DESeq}
gene_wise_pseudo_ref <- perfect_real_data_set |>
  group_by(ProteinGroup) |>
  summarise(pseudo_ref = exp(sum(log(prot_intensity))/length(prot_intensity)))

sample_wise_scale_factors <- perfect_real_data_set |>
  inner_join(gene_wise_pseudo_ref) |>
  group_by(tissue_name, cell_line_name, rep_name) |>
  summarise(sample_scale_factor = median(prot_intensity / pseudo_ref, na.rm = TRUE)) |>
  ungroup()

perfect_real_data_set_normalised = perfect_real_data_set |>
  inner_join(sample_wise_scale_factors) |>
  mutate(prot_intensity = prot_intensity / sample_scale_factor)
```

```{r pre-vs-post-norm}
ggplot(perfect_real_data_set) +
  geom_boxplot(aes(y=log(prot_intensity), x= factor(cell_line))) +
  facet_wrap(~factor(rep),ncol = 1) +
  labs(title = "Unnormalised Intensity")

ggplot(perfect_real_data_set_normalised) +
  geom_boxplot(aes(y=log(prot_intensity), x= factor(cell_line))) +
  facet_wrap(~factor(rep),ncol = 1) +
  labs(title = "Normalised Intensity")
```

```{r run-stan-model-real, eval=FALSE}
n_prot <- 50

n_tissues <- 2

subset_perfect_protein_names <- perfect_real_data_set_normalised |> 
  pull(ProteinGroup) |>
  unique() |>
  sample(n_prot)

subset_perfect_tissue_names <- perfect_real_data_set_normalised |> 
  pull(tissue_name) |>
  unique() |>
  sample(n_tissues)

subset_perfect_data <- perfect_real_data_set_normalised |> 
  filter(ProteinGroup %in% subset_perfect_protein_names,
         tissue_name %in% subset_perfect_tissue_names) |>
  mutate(tissue_name = factor(tissue_name),
         tissue =  unclass(tissue_name),
         cell_line_name = factor(cell_line_name),
         cell_line = unclass(cell_line_name))

n_cell_lines = length(unique(subset_perfect_data$cell_line_name))

n_sample = subset_perfect_data |>
  filter(protein_id == protein_id[1]) |>
  group_by(protein_id) |>
  summarise(n()) |>
  pull(`n()`)

arranged_subset_perfect_data = subset_perfect_data |>
  arrange(tissue,
          cell_line,
          rep,
          ProteinGroup)

protein_intensity_array_real_data <- array(c(arranged_subset_perfect_data |>
  pull(prot_intensity)),
  dim = c(n_prot,
          n_sample)) |>
  aperm(c(2,1))

fit_real <- sampling(model_orig,
                     list(num_samples = n_sample,
                          num_cell_lines = n_cell_lines,
                          num_proteins = n_prot,
                          num_tissue = n_tissues,
                          cell_line = arranged_subset_perfect_data |>
                            filter(protein_id == protein_id[1])  |>
                            pull(cell_line),
                          tissue = arranged_subset_perfect_data |>
                            group_by(cell_line) |>
                            filter(protein_id == protein_id[1],
                                   rep == 1) |> 
                            pull(tissue),
                          prot_intensity = protein_intensity_array_real_data),
                     iter = 1000,
                     chains = 4)


```

```{r explore-posterior}

protein_dictionary <- subset_perfect_data |>
  group_by(ProteinGroup) |>
  summarise(protein_id = protein_id[1]) |>
  mutate(ProteinGroup = factor(ProteinGroup),
         protein_id = unclass(ProteinGroup))

cell_line_dictionary <- subset_perfect_data |>
  group_by(cell_line_name, tissue_name) |>
  summarise(tissue = tissue[1],
            cell_line = cell_line[1])

fit_summary_real <- summary(fit_real)$summary |> 
  as_tibble(rownames = "parameter") |>
  transmute(parameter,
            median = `50%`)

subset_perfect_data_sorted <- arranged_subset_perfect_data |> 
  mutate(ProteinGroup = factor(ProteinGroup),
         protein_id = unclass(ProteinGroup)) |>
  group_by(ProteinGroup) |>
  mutate(sample = rep(1:n_sample))

enrichment_comparison <- subset_perfect_data_sorted |>
          group_by(tissue_name, cell_line_name,
                   rep_name,tissue, cell_line, rep, sample) |> 
          summarise(unique(rep))|>
  inner_join(test_enrichment) |>
  ungroup() |>
  inner_join(fit_real |> 
  spread_draws(enrichment[sample]) |>
  summarise_draws())
  
named_protein_results <- protein_dictionary |> 
  inner_join(fit_real |> 
  spread_draws(chrom_intensity_cell_line_n_min_1[cell_line,protein_id]) |>
  summarise_draws()) |>
  inner_join(cell_line_dictionary)

ggplot(named_protein_results) + 
  geom_point(aes(x=ProteinGroup, y=median)) + 
  facet_wrap(~cell_line_name)

ggplot(test_enrichment) +
  geom_point(aes(x= C, y=N))

ggplot(enrichment_comparison) +
  geom_point(aes(x= median, y=N)) +
  labs(x="Enrichment") +
  geom_abline(slope = 1, intercept = 0)

ggplot(enrichment_comparison) +
  geom_point(aes(x= median, y=C)) +
  labs(x="Enrichment") +
  geom_abline(slope = 1, intercept = 0)

ggplot( tibble(gen_prot_intensity=c(apply(extract(fit_real,"gen_prot_intensity")$gen_prot_intensity,c(2,3),median))) |>
         mutate(sample = rep(1:n_sample, n_prot),
                protein_id = rep(1:n_prot, each = n_sample)) |>
         inner_join(subset_perfect_data_sorted)) +
  geom_point(aes(x = log(gen_prot_intensity), y = log(prot_intensity)))  +
  labs(x="gen_prot_intensity")
```

```{r run-stanfit, eval=FALSE}
launch_shinystan(fit_real)
```